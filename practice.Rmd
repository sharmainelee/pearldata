---
title: "practice"
output: html_document
date: "2025-05-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#ajdhgsfhjg
```{r}
# Load libraries
library(tidyverse)
library(ggplot2)
library(lme4)
library(car)         # for ANOVA
library(emmeans)     # for post-hoc tests
library(ggpubr)      # for combining plots
library(readr)


# View structure and summary
str(PearlOperationalData)
summary(PearlOperationalData)

# -------------------------------------------------------------
# 1. Data cleaning and checking
# -------------------------------------------------------------
# Check for NA values
colSums(is.na(PearlOperationalData))

# Convert categorical variables
#data <- PearlOperationalData %>%
  #mutate(across(c(Location, SaiboArea, HealthStatus, ColourCat), as.factor))

data <- PearlOperationalData %>%
  mutate(across(c(Shell_Metrics_Location, First_Op_Data_LocationIncoming, First_Op_Data_Saibo_Area, Matched_Donor_Data_Saibo_Area_Round_NumberRegions, Matched_Donor_Data_Saibo_Area_Flat_NumberRegions,First_Op_Data_Recovering_doubleback,First_Op_Data_Nacre_Lip_Colour_Round, First_Op_Data_Nacre_Lip_Colour_Flat, Pearl_Grading_Data_Colour, Shell_and_Pearl_colour_Comparisons_Round_Flat_HOST_542_days, Shell_and_Pearl_colour_Comparisons_Round_Flat_HOST_880_days, Shell_and_Pearl_colour_Comparisons_Round_Flat_DONOR_880_days, Matched_Donor_Data_Nacre_lip_colour_Round, Matched_Donor_Data_Nacre_lip_colour_Flat), as.factor))

# -------------------------------------------------------------
# 2. Descriptive plots
# -------------------------------------------------------------

# Pearl size distribution
ggplot(data, aes(x = Pearl_Grading_Data_Size_mm)) +
  geom_histogram(binwidth = 0.5, fill = "skyblue", color = "black") +
  labs(title = "Distribution of Pearl Size", x = "Pearl Size (mm)", y = "Frequency")




# Boxplots for pearl size by factors
#p1 <- ggplot(data, aes(x = Location, y = PearlSize)) +
  #geom_boxplot() +
  #labs(title = "Pearl Size by Location")

#p2 <- ggplot(data, aes(x = SaiboArea, y = PearlSize)) +
  #geom_boxplot() +
  #labs(title = "Pearl Size by Saibo Area")

#p3 <- ggplot(data, aes(x = HealthStatus, y = PearlSize)) +
  #geom_boxplot() +
  #labs(title = "Pearl Size by Health Status")

#ggarrange(p1, p2, p3, ncol = 3)




p1 <- ggplot(data, aes(x = Shell_Metrics_Location
, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by Location", x = "Location", y = "Pearl Size (mm)")

p1

####p2 with NA
#p2 <- ggplot(data, aes(x = First_Op_Data_LocationIncoming
, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by First Operation Data Location Incoming", x = 
         "First Operation Data Location", y = "Pearl Size (mm)")

####p2 remove NA

library(ggplot2)
library(dplyr)

# Remove NAs from the specific columns used in the plot
p2 <- ggplot(data %>% drop_na(First_Op_Data_LocationIncoming, Pearl_Grading_Data_Size_mm), 
             aes(x = First_Op_Data_LocationIncoming, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by First Operation Data Location Incoming", 
       x = "First Operation Data Location", 
       y = "Pearl Size (mm)")

# Print the plot
print(p2)



####pearl size by saibo area with NA
#p3 <- ggplot(data, aes(x = First_Op_Data_Saibo_Area, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by Saibo Area", x = 
    "First Operation Data Saibo Area", y = "Pearl Size (mm)")





####p3 remove NA

library(ggplot2)
library(dplyr)

# Remove NAs for the specific columns used in the plot
p3 <- ggplot(data %>% drop_na(First_Op_Data_Saibo_Area, Pearl_Grading_Data_Size_mm), 
             aes(x = First_Op_Data_Saibo_Area, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by Saibo Area", 
       x = "First Operation Data Saibo Area", 
       y = "Pearl Size (mm)")

# Print the plot
print(p3)

####IDEA MAYBE DO ANOVA TO TEST IF F3 AND R3 SIGNIFICANT IN PRODUCING LARGER PEARL SIZES



#### p4 with NA
#p4 <- ggplot(data, aes(x = First_Op_Data_Recovering_doubleback
#, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by Health Status", 
       x = "First Operation Data Recovering Double-back", 
       y = "Pearl Size (mm)")

#### p4 remove NA
library(ggplot2)
library(dplyr)

# Remove NAs for the specific columns used in the plot
p4 <- ggplot(data %>% drop_na(First_Op_Data_Recovering_doubleback, Pearl_Grading_Data_Size_mm), 
             aes(x = First_Op_Data_Recovering_doubleback, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by Health Status", 
       x = "First Operation Data Recovering Double-back", 
       y = "Pearl Size (mm)")

# Print the plot
print(p4)



#ggarrange(p1, p2, p3, p4, ncol = 4)

ggarrange(p1,p2, p3, p4)

# -------------------------------------------------------------
# 3. ANOVA: Which factors affect Pearl Size?
# -------------------------------------------------------------

# Linear model
#lm1 <- lm(PearlSize ~ Location + SaiboArea + HealthStatus, data = data)
#anova(lm1)


lm1 <- lm(Pearl_Grading_Data_Size_mm
 ~ Shell_Metrics_Location
 + First_Op_Data_Saibo_Area
 + First_Op_Data_Recovering_doubleback
, data = data)
anova(lm1)



# Post-hoc tests
#emmeans(lm1, pairwise ~ Location)
#emmeans(lm1, pairwise ~ SaiboArea)
#emmeans(lm1, pairwise ~ HealthStatus)

emmeans(lm1, pairwise ~ Shell_Metrics_Location)
emmeans(lm1, pairwise ~ First_Op_Data_Saibo_Area)
emmeans(lm1, pairwise ~ First_Op_Data_Recovering_doubleback)

#### First_Op_Data_Saibo_Area vs Pearl_Grading_Data_Colour

library(ggplot2)
library(dplyr)

# Remove NAs for the relevant columns
plot_data <- data %>% drop_na(First_Op_Data_Saibo_Area, Pearl_Grading_Data_Colour)

# Plot
p5 <- ggplot(plot_data, aes(x = First_Op_Data_Saibo_Area, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Distribution of Pearl Colour by Saibo Area", 
       x = "First Operation Data Saibo Area", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  theme_minimal()

print(p5)



library(ggmosaic)

ggplot(plot_data) +
  geom_mosaic(aes(weight = 1, x = product(First_Op_Data_Saibo_Area), fill = Pearl_Grading_Data_Colour)) +
  labs(title = "Pearl Colour by Saibo Area", 
       x = "First Operation Data Saibo Area", 
       y = "Pearl Colour") +
   theme(axis.text.y = element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x = element_text(angle = 90),
        legend.position = "right")




library(ggplot2)
library(dplyr)

# Define the updated pearl colors
pearl_colors <- c(
  "Blue" = "#0000FF", 
  "Champagne" = "#F7E7CE", 
  "Cream" = "#FFFDD0", 
  "Gold" = "#FFD700", 
  "Gold Silver" = "#A6996E", 
  "Gold White" = "#F8DE7E", 
  "Green" = "#008000", 
  "Light Champ" = "#E7E2D7", 
  "Low Grade" = "#808080", 
  "No Grade" = "#36454F", 
  "Ombre" = "#326872", 
  "Pair" = "#C8A2C8", 
  "Peach" = "#FFE5B4", 
  "Rainbow" = "#FF00FF", 
  "Silver" = "#C0C0C0", 
  "Silver Gold" = "#C6C7BE", 
  "Silver Pink" = "#D1C5D3", 
  "Silver White" = "#E5E4E2", 
  "White" = "#F9F6EE", 
  "White Cream" = "#FFF8DC", 
  "White Gold" = "#F7EAD5", 
  "White Pink" = "#FFD1DC", 
  "White Silver" = "#F2F0EF"
)

# Prepare data (remove NAs)
plot_data <- data %>% drop_na(First_Op_Data_Saibo_Area, Pearl_Grading_Data_Colour)

# Create the plot
p6 <- ggplot(plot_data, aes(x = First_Op_Data_Saibo_Area, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Distribution of Pearl Colour by Saibo Area", 
       x = "First Operation Data Saibo Area", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme_minimal()

# Print the plot
print(p6)


#9 MAY 2025

library(ggplot2)
library(dplyr)

# Define the updated pearl colors
pearl_colors <- c(
  "Blue" = "#0000FF", 
  "Champagne" = "#F7E7CE", 
  "Cream" = "#FFFDD0", 
  "Gold" = "#FFD700", 
  "Gold Silver" = "#A6996E", 
  "Gold White" = "#F8DE7E", 
  "Green" = "#008000", 
  "Light Champ" = "#E7E2D7", 
  "Low Grade" = "#808080", 
  "No Grade" = "#36454F", 
  "Ombre" = "#326872", 
  "Pair" = "#C8A2C8", 
  "Peach" = "#FFE5B4", 
  "Rainbow" = "#FF00FF", 
  "Silver" = "#C0C0C0", 
  "Silver Gold" = "#C6C7BE", 
  "Silver Pink" = "#D1C5D3", 
  "Silver White" = "#E5E4E2", 
  "White" = "#F9F6EE", 
  "White Cream" = "#FFF8DC", 
  "White Gold" = "#F7EAD5", 
  "White Pink" = "#FFD1DC", 
  "White Silver" = "#F2F0EF"
)

# Remove NAs for the relevant columns
plot_data <- data %>% drop_na(Pearl_Grading_Data_Colour, Shell_Metrics_Location)

# Create the plot
p7 <- ggplot(plot_data, aes(x = Shell_Metrics_Location, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Pearl Colour Distribution by Shell Location", 
       x = "Shell Metrics Location", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Print the plot
print(p7)

#alternative
library(ggmosaic)

ggplot(plot_data) +
  geom_mosaic(aes(weight = 1, x = product(Shell_Metrics_Location), fill = Pearl_Grading_Data_Colour)) +
  labs(title = "Pearl Colour by Shell Location", 
       x = "Shell Metrics Location", 
       y = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x = element_text(angle = 90),
        legend.position = "right")



















##############################################################
# -------------------------------------------------------------
# 4. Mixed Model (for genetic analysis prep)
# -------------------------------------------------------------

# Assuming you have 'AnimalID', 'DamID', and 'SireID' for pedigree
# If you aim to estimate heritability and EBVs, use animal models

# Example model for pearl colour (quantitative e.g. RGB_Red)
model_rgb <- lmer(RGB_Red ~ Location + (1|AnimalID), data = data)

# Summary
summary(model_rgb)

# Repeat for other traits like RGB_Green, RGB_Blue, PearlSize

# -------------------------------------------------------------
# 5. Suggestions for further genetic analysis
# -------------------------------------------------------------

# Use packages like MCMCglmm or sommer for animal model-based heritability:
# install.packages("sommer")
library(sommer)

# Example heritability model for quantitative colour
herit_model <- mmer(RGB_Red ~ Location,
                    random = ~ vsr(AnimalID, Gu = A_matrix),
                    data = data)

# You need to build A_matrix from pedigree first using pedigree::kinship or sommer::A.mat
```
