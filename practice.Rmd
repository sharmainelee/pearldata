---
title: "practice"
output: html_document
date: "2025-05-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#ajdhgsfhjg
```{r}
# Load libraries
library(tidyverse)
library(ggplot2)
library(lme4)
library(car)         # for ANOVA
library(emmeans)     # for post-hoc tests
library(ggpubr)      # for combining plots
library(readr)


# View structure and summary
str(PearlOperationalData)
summary(PearlOperationalData)

# -------------------------------------------------------------
# 1. Data cleaning and checking
# -------------------------------------------------------------
# Check for NA values
colSums(is.na(PearlOperationalData))

# Convert categorical variables
#data <- PearlOperationalData %>%
  #mutate(across(c(Location, SaiboArea, HealthStatus, ColourCat), as.factor))

data <- PearlOperationalData %>%
  mutate(across(c(Shell_Metrics_Location, First_Op_Data_LocationIncoming, First_Op_Data_Saibo_Area, Matched_Donor_Data_Saibo_Area_Round_NumberRegions, Matched_Donor_Data_Saibo_Area_Flat_NumberRegions,First_Op_Data_Recovering_doubleback,First_Op_Data_Nacre_Lip_Colour_Round, First_Op_Data_Nacre_Lip_Colour_Flat, Pearl_Grading_Data_Colour, Shell_and_Pearl_colour_Comparisons_Round_Flat_HOST_542_days, Shell_and_Pearl_colour_Comparisons_Round_Flat_HOST_880_days, Shell_and_Pearl_colour_Comparisons_Round_Flat_DONOR_880_days, Matched_Donor_Data_Nacre_lip_colour_Round, Matched_Donor_Data_Nacre_lip_colour_Flat), as.factor))

# -------------------------------------------------------------
# 2. Descriptive plots
# -------------------------------------------------------------

# Pearl size distribution
ggplot(data, aes(x = Pearl_Grading_Data_Size_mm)) +
  geom_histogram(binwidth = 0.5, fill = "skyblue", color = "black") +
  labs(title = "Distribution of Pearl Size", x = "Pearl Size (mm)", y = "Frequency")




# Boxplots for pearl size by factors
#p1 <- ggplot(data, aes(x = Location, y = PearlSize)) +
  #geom_boxplot() +
  #labs(title = "Pearl Size by Location")

#p2 <- ggplot(data, aes(x = SaiboArea, y = PearlSize)) +
  #geom_boxplot() +
  #labs(title = "Pearl Size by Saibo Area")

#p3 <- ggplot(data, aes(x = HealthStatus, y = PearlSize)) +
  #geom_boxplot() +
  #labs(title = "Pearl Size by Health Status")

#ggarrange(p1, p2, p3, ncol = 3)




p1 <- ggplot(data, aes(x = Shell_Metrics_Location
, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by Location", x = "Location", y = "Pearl Size (mm)")

p1

####p2 with NA
#p2 <- ggplot(data, aes(x = First_Op_Data_LocationIncoming
, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by First Operation Data Location Incoming", x = 
         "First Operation Data Location", y = "Pearl Size (mm)")

####p2 remove NA

library(ggplot2)
library(dplyr)

# Remove NAs from the specific columns used in the plot
p2 <- ggplot(data %>% drop_na(First_Op_Data_LocationIncoming, Pearl_Grading_Data_Size_mm), 
             aes(x = First_Op_Data_LocationIncoming, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by First Operation Data Location Incoming", 
       x = "First Operation Data Location", 
       y = "Pearl Size (mm)")

# Print the plot
print(p2)



####pearl size by saibo area with NA
#p3 <- ggplot(data, aes(x = First_Op_Data_Saibo_Area, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by Saibo Area", x = 
    "First Operation Data Saibo Area", y = "Pearl Size (mm)")





####p3 remove NA

library(ggplot2)
library(dplyr)

# Remove NAs for the specific columns used in the plot
p3 <- ggplot(data %>% drop_na(First_Op_Data_Saibo_Area, Pearl_Grading_Data_Size_mm), 
             aes(x = First_Op_Data_Saibo_Area, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by Saibo Area", 
       x = "First Operation Data Saibo Area", 
       y = "Pearl Size (mm)")

# Print the plot
print(p3)

####IDEA MAYBE DO ANOVA TO TEST IF F3 AND R3 SIGNIFICANT IN PRODUCING LARGER PEARL SIZES



#### p4 with NA
#p4 <- ggplot(data, aes(x = First_Op_Data_Recovering_doubleback
#, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by Health Status", 
       x = "First Operation Data Recovering Double-back", 
       y = "Pearl Size (mm)")

#### p4 remove NA
library(ggplot2)
library(dplyr)

# Remove NAs for the specific columns used in the plot
p4 <- ggplot(data %>% drop_na(First_Op_Data_Recovering_doubleback, Pearl_Grading_Data_Size_mm), 
             aes(x = First_Op_Data_Recovering_doubleback, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Pearl Size by Health Status", 
       x = "First Operation Data Recovering Double-back", 
       y = "Pearl Size (mm)")

# Print the plot
print(p4)



#ggarrange(p1, p2, p3, p4, ncol = 4)

ggarrange(p1,p2, p3, p4)

# -------------------------------------------------------------
# 3. ANOVA: Which factors affect Pearl Size?
# -------------------------------------------------------------

# Linear model
#lm1 <- lm(PearlSize ~ Location + SaiboArea + HealthStatus, data = data)
#anova(lm1)


lm1 <- lm(Pearl_Grading_Data_Size_mm
 ~ Shell_Metrics_Location
 + First_Op_Data_Saibo_Area
 + First_Op_Data_Recovering_doubleback
, data = data)
anova(lm1)



# Post-hoc tests
#emmeans(lm1, pairwise ~ Location)
#emmeans(lm1, pairwise ~ SaiboArea)
#emmeans(lm1, pairwise ~ HealthStatus)

emmeans(lm1, pairwise ~ Shell_Metrics_Location)
emmeans(lm1, pairwise ~ First_Op_Data_Saibo_Area)
emmeans(lm1, pairwise ~ First_Op_Data_Recovering_doubleback)

#### First_Op_Data_Saibo_Area vs Pearl_Grading_Data_Colour

library(ggplot2)
library(dplyr)

# Remove NAs for the relevant columns
plot_data <- data %>% drop_na(First_Op_Data_Saibo_Area, Pearl_Grading_Data_Colour)

# Plot
p5 <- ggplot(plot_data, aes(x = First_Op_Data_Saibo_Area, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Distribution of Pearl Colour by Saibo Area", 
       x = "First Operation Data Saibo Area", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  theme_minimal()

print(p5)



library(ggmosaic)

ggplot(plot_data) +
  geom_mosaic(aes(weight = 1, x = product(First_Op_Data_Saibo_Area), fill = Pearl_Grading_Data_Colour)) +
  labs(title = "Pearl Colour by Saibo Area", 
       x = "First Operation Data Saibo Area", 
       y = "Pearl Colour") +
   theme(axis.text.y = element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x = element_text(angle = 90),
        legend.position = "right")




library(ggplot2)
library(dplyr)

# Define the updated pearl colors
pearl_colors <- c(
  "Blue" = "#0000FF", 
  "Champagne" = "#F7E7CE", 
  "Cream" = "#FFFDD0", 
  "Gold" = "#FFD700", 
  "Gold Silver" = "#A6996E", 
  "Gold White" = "#F8DE7E", 
  "Green" = "#008000", 
  "Light Champ" = "#E7E2D7", 
  "Low Grade" = "#808080", 
  "No Grade" = "#36454F", 
  "Ombre" = "#326872", 
  "Pair" = "#C8A2C8", 
  "Peach" = "#FFE5B4", 
  "Rainbow" = "#FF00FF", 
  "Silver" = "#C0C0C0", 
  "Silver Gold" = "#C6C7BE", 
  "Silver Pink" = "#D1C5D3", 
  "Silver White" = "#E5E4E2", 
  "White" = "#F9F6EE", 
  "White Cream" = "#FFF8DC", 
  "White Gold" = "#F7EAD5", 
  "White Pink" = "#FFD1DC", 
  "White Silver" = "#F2F0EF"
)

# Prepare data (remove NAs)
plot_data <- data %>% drop_na(First_Op_Data_Saibo_Area, Pearl_Grading_Data_Colour)

# Create the plot
p6 <- ggplot(plot_data, aes(x = First_Op_Data_Saibo_Area, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Distribution of Pearl Colour by Saibo Area", 
       x = "First Operation Data Saibo Area", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme_minimal()

# Print the plot
print(p6)


#9 MAY 2025

library(ggplot2)
library(dplyr)

# Define the updated pearl colors
pearl_colors <- c(
  "Blue" = "#0000FF", 
  "Champagne" = "#F7E7CE", 
  "Cream" = "#FFFDD0", 
  "Gold" = "#FFD700", 
  "Gold Silver" = "#A6996E", 
  "Gold White" = "#F8DE7E", 
  "Green" = "#008000", 
  "Light Champ" = "#E7E2D7", 
  "Low Grade" = "#808080", 
  "No Grade" = "#36454F", 
  "Ombre" = "#326872", 
  "Pair" = "#C8A2C8", 
  "Peach" = "#FFE5B4", 
  "Rainbow" = "#FF00FF", 
  "Silver" = "#C0C0C0", 
  "Silver Gold" = "#C6C7BE", 
  "Silver Pink" = "#D1C5D3", 
  "Silver White" = "#E5E4E2", 
  "White" = "#F9F6EE", 
  "White Cream" = "#FFF8DC", 
  "White Gold" = "#F7EAD5", 
  "White Pink" = "#FFD1DC", 
  "White Silver" = "#F2F0EF"
)

# Remove NAs for the relevant columns
plot_data <- data %>% drop_na(Pearl_Grading_Data_Colour, Shell_Metrics_Location)

# Create the plot
p7 <- ggplot(plot_data, aes(x = Shell_Metrics_Location, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Pearl Colour Distribution by Shell Location", 
       x = "Shell Metrics Location", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Print the plot
print(p7)

#alternative
library(ggmosaic)

ggplot(plot_data) +
  geom_mosaic(aes(weight = 1, x = product(Shell_Metrics_Location), fill = Pearl_Grading_Data_Colour)) +
  labs(title = "Pearl Colour by Shell Location", 
       x = "Shell Metrics Location", 
       y = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme(axis.text.y = element_blank(),
        axis.ticks.y=element_blank(),
        axis.text.x = element_text(angle = 90),
        legend.position = "right")




####  did the year 2019 batch change colour in year 2020?
library(ggplot2)
library(dplyr)

# Define custom colors for lip types
lip_colors <- c(
  "Gr" = "green", 
  "S" = "#C0C0C0", 
  "Y" = "yellow"
)

# Filter for the 2019 batch only, removing NAs
batch_2019 <- data %>%
  drop_na(Shell_Metrics_Nacre_Lip_Colour_Round, 
          Shell_Metrics_Nacre_Lip_Colour_Flat, 
          First_Op_Data_Nacre_Lip_Colour_Round, 
          First_Op_Data_Nacre_Lip_Colour_Flat)

# Combine round and flat lip color data for easier comparison
color_data <- batch_2019 %>%
  select(Shell_Metrics_Nacre_Lip_Colour_Round, First_Op_Data_Nacre_Lip_Colour_Round) %>%
  rename(Year_2019 = Shell_Metrics_Nacre_Lip_Colour_Round, 
         Year_2020 = First_Op_Data_Nacre_Lip_Colour_Round) %>%
  mutate(Type = "Round") %>%
  bind_rows(
    batch_2019 %>%
      select(Shell_Metrics_Nacre_Lip_Colour_Flat, First_Op_Data_Nacre_Lip_Colour_Flat) %>%
      rename(Year_2019 = Shell_Metrics_Nacre_Lip_Colour_Flat, 
             Year_2020 = First_Op_Data_Nacre_Lip_Colour_Flat) %>%
      mutate(Type = "Flat")
  )

# Create a comparison plot
p9 <- ggplot(color_data, aes(x = Year_2019, fill = Year_2020)) +
  geom_bar(position = "fill") +
  facet_wrap(~Type) +
  labs(title = "Nacre Lip Colour Change (2019 to 2020)", 
       x = "2019 Nacre Lip Colour", 
       y = "Proportion in 2020", 
       fill = "2020 Nacre Lip Colour") +
  scale_fill_manual(values = lip_colors) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(p9)






#### did lip colour at FOP relate to pearl colour

library(dplyr)
library(ggplot2)

# Remove NAs for the relevant columns
data_clean <- data %>% 
  drop_na(First_Op_Data_Nacre_Lip_Colour_Round, 
          First_Op_Data_Nacre_Lip_Colour_Flat, 
          Pearl_Grading_Data_Colour)

# Cross-tabulation ******* does it make sense???
round_table <- table(data_clean$First_Op_Data_Nacre_Lip_Colour_Round, data_clean$Pearl_Grading_Data_Colour)
flat_table <- table(data_clean$First_Op_Data_Nacre_Lip_Colour_Flat, data_clean$Pearl_Grading_Data_Colour)

# Chi-square test
round_test <- chisq.test(round_table)
flat_test <- chisq.test(flat_table)

round_test
flat_test

#Nacre lip color (round or flat) is independent of pearl color




# Round lip color relationship
ggplot(data_clean, aes(x = First_Op_Data_Nacre_Lip_Colour_Round, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Pearl Colour by Round Nacre Lip Colour", 
       x = "Round Nacre Lip Colour", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme_minimal()

# Flat lip color relationship
ggplot(data_clean, aes(x = First_Op_Data_Nacre_Lip_Colour_Flat, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Pearl Colour by Flat Nacre Lip Colour", 
       x = "Flat Nacre Lip Colour", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme_minimal()




####Gonad condition related to pearl colour? 
library(ggplot2)
library(dplyr)

# Prepare the data for each gonad condition source
gonad_data <- data %>%
  drop_na(Shell_Metrics_Gonad_Condition, Pearl_Grading_Data_Colour) %>%
  select(Shell_Metrics_Gonad_Condition, Pearl_Grading_Data_Colour) %>%
  rename(Gonad_Condition = Shell_Metrics_Gonad_Condition) %>%
  mutate(Source = "Shell Metrics") %>%
  bind_rows(
    data %>%
      drop_na(First_Op_Data_Gonad_Condition, Pearl_Grading_Data_Colour) %>%
      select(First_Op_Data_Gonad_Condition, Pearl_Grading_Data_Colour) %>%
      rename(Gonad_Condition = First_Op_Data_Gonad_Condition) %>%
      mutate(Source = "First Operation")
  ) %>%
  bind_rows(
    data %>%
      drop_na(Matched_Donor_Data_Gonad_Condition, Pearl_Grading_Data_Colour) %>%
      select(Matched_Donor_Data_Gonad_Condition, Pearl_Grading_Data_Colour) %>%
      rename(Gonad_Condition = Matched_Donor_Data_Gonad_Condition) %>%
      mutate(Source = "Matched Donor")
  )

# Create the plot
p11 <- ggplot(gonad_data, aes(x = Gonad_Condition, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  facet_wrap(~Source) +
  labs(title = "Gonad Condition vs Pearl Colour", 
       x = "Gonad Condition", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(p11)




#### Shell_Metrics_Gonad_Condition, First_Op_Data_Gonad_Condition,  Matched_Donor_Data_Gonad_Condition  are categorical variables. compare the gonad conditions to Pearl_Grading_Data_Colour

## Chi-Square test for association

library(dplyr)
library(ggplot2)

# Remove NAs for the relevant columns
data_clean <- data %>% 
  drop_na(Shell_Metrics_Gonad_Condition, 
          First_Op_Data_Gonad_Condition, 
          Matched_Donor_Data_Gonad_Condition, 
          Pearl_Grading_Data_Colour)

# Chi-square tests
shell_test <- chisq.test(table(data_clean$Shell_Metrics_Gonad_Condition, data_clean$Pearl_Grading_Data_Colour))
first_op_test <- chisq.test(table(data_clean$First_Op_Data_Gonad_Condition, data_clean$Pearl_Grading_Data_Colour))
donor_test <- chisq.test(table(data_clean$Matched_Donor_Data_Gonad_Condition, data_clean$Pearl_Grading_Data_Colour))

shell_test
first_op_test
donor_test




#### visualise gonad condition and pearl colour


# Shell Metrics Gonad Condition
ggplot(data_clean, aes(x = Shell_Metrics_Gonad_Condition, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Pearl Colour by Shell Metrics Gonad Condition", 
       x = "Shell Metrics Gonad Condition", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme_minimal()

# First Operation Gonad Condition
ggplot(data_clean, aes(x = First_Op_Data_Gonad_Condition, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Pearl Colour by First Operation Gonad Condition", 
       x = "First Operation Gonad Condition", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme_minimal()

# Matched Donor Gonad Condition
ggplot(data_clean, aes(x = Matched_Donor_Data_Gonad_Condition, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Pearl Colour by Matched Donor Gonad Condition", 
       x = "Matched Donor Gonad Condition", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme_minimal()


#### compare Shell_Metrics_Shell_Weight_g, First_Op_Data_Shell_Weight_g, Pearl_Harvest_Data_Shell_Weight_g, Matched_Donor_Data_Shell_Weight_g with Pearl_Grading_Data_Size_mm

#data preparation
library(ggplot2)
library(dplyr)
library(GGally)

# Remove NAs for the relevant columns
data_clean <- data %>% 
  drop_na(Shell_Metrics_Shell_Weight_g, 
          First_Op_Data_Shell_Weight_g, 
          Pearl_Harvest_Data_Shell_Weight_g, 
          Matched_Donor_Data_Shell_Weight_g, 
          Pearl_Grading_Data_Size_mm)

# Quick summary to check data distribution
summary(data_clean)


##scatter plots with linear regression

# Scatter plots with regression lines
ggplot(data_clean, aes(x = Shell_Metrics_Shell_Weight_g, y = Pearl_Grading_Data_Size_mm)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "blue", se = FALSE) +
  labs(title = "Pearl Size vs Shell Metrics Shell Weight", 
       x = "Shell Metrics Shell Weight (g)", 
       y = "Pearl Size (mm)") +
  theme_minimal()

ggplot(data_clean, aes(x = First_Op_Data_Shell_Weight_g, y = Pearl_Grading_Data_Size_mm)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "green", se = FALSE) +
  labs(title = "Pearl Size vs First Operation Shell Weight", 
       x = "First Op Shell Weight (g)", 
       y = "Pearl Size (mm)") +
  theme_minimal()

ggplot(data_clean, aes(x = Pearl_Harvest_Data_Shell_Weight_g, y = Pearl_Grading_Data_Size_mm)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "gold", se = FALSE) +
  labs(title = "Pearl Size vs Pearl Harvest Shell Weight", 
       x = "Pearl Harvest Shell Weight (g)", 
       y = "Pearl Size (mm)") +
  theme_minimal()

ggplot(data_clean, aes(x = Matched_Donor_Data_Shell_Weight_g, y = Pearl_Grading_Data_Size_mm)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", color = "purple", se = FALSE) +
  labs(title = "Pearl Size vs Matched Donor Shell Weight", 
       x = "Matched Donor Shell Weight (g)", 
       y = "Pearl Size (mm)") +
  theme_minimal()

####correlation matrix

# Create a subset for correlation
cor_data <- data_clean %>%
  select(Shell_Metrics_Shell_Weight_g, 
         First_Op_Data_Shell_Weight_g, 
         Pearl_Harvest_Data_Shell_Weight_g, 
         Matched_Donor_Data_Shell_Weight_g, 
         Pearl_Grading_Data_Size_mm)

# Plot correlation matrix
ggpairs(cor_data, title = "Correlation Matrix of Shell Weights and Pearl Size")



##Regression Models

# Linear models
model1 <- lm(Pearl_Grading_Data_Size_mm ~ Shell_Metrics_Shell_Weight_g, data = data_clean)
model2 <- lm(Pearl_Grading_Data_Size_mm ~ First_Op_Data_Shell_Weight_g, data = data_clean)
model3 <- lm(Pearl_Grading_Data_Size_mm ~ Pearl_Harvest_Data_Shell_Weight_g, data = data_clean)
model4 <- lm(Pearl_Grading_Data_Size_mm ~ Matched_Donor_Data_Shell_Weight_g, data = data_clean)

summary(model1)
summary(model2)
summary(model3)
summary(model4)





#### pearl size related to location?
## data preparation
library(ggplot2)
library(dplyr)

# Remove NAs for the relevant columns
data_clean <- data %>% 
  drop_na(Shell_Metrics_Location, Pearl_Grading_Data_Size_mm)

# Quick summary to check data distribution
summary(data_clean)


# Box plot to visualize the relationship
ggplot(data_clean, aes(x = Shell_Metrics_Location, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot(fill = "#69b3a2", color = "black", outlier.color = "red", outlier.size = 2) +
  labs(title = "Pearl Size by Shell Metrics Location", 
       x = "Shell Metrics Location", 
       y = "Pearl Size (mm)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# Run ANOVA
anova_model <- aov(Pearl_Grading_Data_Size_mm ~ Shell_Metrics_Location, data = data_clean)
summary(anova_model)

# Post-hoc test #if significant, however it is not
if (summary(anova_model)[[1]]$`Pr(>F)`[1] < 0.05) {
  library(multcomp)
  posthoc_results <- TukeyHSD(anova_model)
  print(posthoc_results)
  
  # Plot the post-hoc results
  plot(posthoc_results, las = 1, col = "blue")
}







##doubleback vs location/colour/size/grade

library(ggplot2)
library(dplyr)


# 1. Double-back vs Location
p_location <- ggplot(data, aes(x = First_Op_Data_Recovering_doubleback, fill = Shell_Metrics_Location)) +
  geom_bar(position = "fill") +
  labs(title = "Double-back Recovery vs Location", 
       x = "Double-back Recovery", 
       y = "Proportion", 
       fill = "Location") +
  theme_minimal()

print(p_location)





# 2. Double-back vs Pearl Colour
p_colour <- ggplot(data, aes(x = First_Op_Data_Recovering_doubleback, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Double-back Recovery vs Pearl Colour", 
       x = "Double-back Recovery", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme_minimal()

print(p_colour)

# 3. Double-back vs Pearl Size
p_size <- ggplot(data, aes(x = First_Op_Data_Recovering_doubleback, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Double-back Recovery vs Pearl Size", 
       x = "Double-back Recovery", 
       y = "Pearl Size (mm)") +
  theme_minimal()

print(p_size)

# 4. Double-back vs Pearl Grade
p_grade <- ggplot(data, aes(x = First_Op_Data_Recovering_doubleback, fill = Pearl_Grading_Data_Grade)) +
  geom_bar(position = "fill") +
  labs(title = "Double-back Recovery vs Pearl Grade", 
       x = "Double-back Recovery", 
       y = "Proportion", 
       fill = "Pearl Grade") +
  theme_minimal()

print(p_grade)


## remove NA for doubleback recovery vs location/colour/size/grade
library(ggplot2)
library(dplyr)



# Helper function to drop both NA and "na"
clean_data <- function(df, cols) {
  df %>%
    drop_na(all_of(cols)) %>%
    filter(!if_any(all_of(cols), ~ . %in% c("na", "NA")))
}

# 1. Double-back vs Location (NA and "na" Removed)
p_location <- clean_data(data, c("First_Op_Data_Recovering_doubleback", "Shell_Metrics_Location")) %>%
  ggplot(aes(x = First_Op_Data_Recovering_doubleback, fill = Shell_Metrics_Location)) +
  geom_bar(position = "fill") +
  labs(title = "Double-back Recovery vs Location", 
       x = "Double-back Recovery", 
       y = "Proportion", 
       fill = "Location") +
  theme_minimal()

print(p_location)

# 2. Double-back vs Pearl Colour (NA and "na" Removed)
p_colour <- clean_data(data, c("First_Op_Data_Recovering_doubleback", "Pearl_Grading_Data_Colour")) %>%
  ggplot(aes(x = First_Op_Data_Recovering_doubleback, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Double-back Recovery vs Pearl Colour", 
       x = "Double-back Recovery", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme_minimal()

print(p_colour)

# 3. Double-back vs Pearl Size (NA and "na" Removed)
p_size <- clean_data(data, c("First_Op_Data_Recovering_doubleback", "Pearl_Grading_Data_Size_mm")) %>%
  ggplot(aes(x = First_Op_Data_Recovering_doubleback, y = Pearl_Grading_Data_Size_mm)) +
  geom_boxplot() +
  labs(title = "Double-back Recovery vs Pearl Size", 
       x = "Double-back Recovery", 
       y = "Pearl Size (mm)") +
  theme_minimal()

print(p_size)

# 4. Double-back vs Pearl Grade (NA and "na" Removed)
library(ggplot2)
library(dplyr)

# Define the ordered levels for Pearl_Grading_Data_Grade
grade_levels <- c("A1+", "A1", "A2+", "A2", "A3+", "A3", "A", 
                  "B1+", "B1", "B2+", "B2", "LG", "NG")

# Clean the data to remove NA and "na"
cleaned_data <- data %>%
  drop_na(First_Op_Data_Recovering_doubleback, Pearl_Grading_Data_Grade) %>%
  filter(!First_Op_Data_Recovering_doubleback %in% c("na", "NA"),
         !Pearl_Grading_Data_Grade %in% c("na", "NA")) %>%
  mutate(Pearl_Grading_Data_Grade = factor(Pearl_Grading_Data_Grade, levels = grade_levels))

# Create the plot
p_grade <- ggplot(cleaned_data, aes(x = First_Op_Data_Recovering_doubleback, fill = Pearl_Grading_Data_Grade)) +
  geom_bar(position = "fill") +
  labs(title = "Double-back Recovery vs Pearl Grade", 
       x = "Double-back Recovery", 
       y = "Proportion", 
       fill = "Pearl Grade") +
  theme_minimal()

print(p_grade)


##nuclei size - size of pearl/ colour/ grade
library(ggplot2)
library(dplyr)

# Define the ordered levels for Pearl Grades
grade_levels <- c("A1+", "A1", "A2+", "A2", "A3+", "A3", "A", 
                  "B1+", "B1", "B2+", "B2", "LG", "NG")



# Helper function to clean data
clean_data <- function(df, cols) {
  df %>%
    drop_na(all_of(cols)) %>%
    filter(!if_any(all_of(cols), ~ . %in% c("na", "NA")))
}

# 1. Nuclei Size vs Pearl Size
p_size <- clean_data(data, c("First_Op_Data_Nuclei_Size", "Pearl_Grading_Data_Size_mm")) %>%
  ggplot(aes(x = First_Op_Data_Nuclei_Size, y = Pearl_Grading_Data_Size_mm)) +
  geom_point(alpha = 0.6, color = "#4682B4") +
  geom_smooth(method = "lm", color = "#FF4500", se = FALSE) +
  labs(title = "Nuclei Size vs Pearl Size", 
       x = "Nuclei Size (mm)", 
       y = "Pearl Size (mm)") +
  theme_minimal()

print(p_size)

# 2. Nuclei Size vs Pearl Colour
p_colour <- clean_data(data, c("First_Op_Data_Nuclei_Size", "Pearl_Grading_Data_Colour")) %>%
  ggplot(aes(x = First_Op_Data_Nuclei_Size, fill = Pearl_Grading_Data_Colour)) +
  geom_bar(position = "fill") +
  labs(title = "Nuclei Size vs Pearl Colour", 
       x = "Nuclei Size (mm)", 
       y = "Proportion", 
       fill = "Pearl Colour") +
  scale_fill_manual(values = pearl_colors) +
  theme_minimal()

print(p_colour)

# 3. Nuclei Size vs Pearl Grade
p_grade <- clean_data(data, c("First_Op_Data_Nuclei_Size", "Pearl_Grading_Data_Grade")) %>%
  mutate(Pearl_Grading_Data_Grade = factor(Pearl_Grading_Data_Grade, levels = grade_levels)) %>%
  ggplot(aes(x = First_Op_Data_Nuclei_Size, fill = Pearl_Grading_Data_Grade)) +
  geom_bar(position = "fill") +
  labs(title = "Nuclei Size vs Pearl Grade", 
       x = "Nuclei Size (mm)", 
       y = "Proportion", 
       fill = "Pearl Grade") +
  theme_minimal()

print(p_grade)


























































##############################################################
# -------------------------------------------------------------
# 4. Mixed Model (for genetic analysis prep)
# -------------------------------------------------------------

# Assuming you have 'AnimalID', 'DamID', and 'SireID' for pedigree
# If you aim to estimate heritability and EBVs, use animal models

# Example model for pearl colour (quantitative e.g. RGB_Red)
model_rgb <- lmer(RGB_Red ~ Location + (1|AnimalID), data = data)

# Summary
summary(model_rgb)

# Repeat for other traits like RGB_Green, RGB_Blue, PearlSize

# -------------------------------------------------------------
# 5. Suggestions for further genetic analysis
# -------------------------------------------------------------

# Use packages like MCMCglmm or sommer for animal model-based heritability:
# install.packages("sommer")
library(sommer)

# Example heritability model for quantitative colour
herit_model <- mmer(RGB_Red ~ Location,
                    random = ~ vsr(AnimalID, Gu = A_matrix),
                    data = data)

# You need to build A_matrix from pedigree first using pedigree::kinship or sommer::A.mat
```
